<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Historial de Solicitudes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body { font-family: Arial; background: #f0f2f5; margin:0; padding:20px;}
    .box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px #ccc; max-width: 600px; margin:auto; margin-top:20px;}
    h2 { text-align:center; margin-bottom:20px;}
    .filtro { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;}
    input[type="date"], button { flex:1; padding:10px; border-radius:6px; border:1px solid #aaa; font-size:14px;}
    button { background:#007bff; color:white; border:none; cursor:pointer;}
    button:hover { background:#0056b3;}
    .solicitud { border-left:5px solid #28a745; background:#f8f9fa; padding:10px; margin-bottom:12px; border-radius:6px;}
    .solicitud h3 { margin:0; cursor:pointer;}
    table { width:100%; border-collapse:collapse; margin-top:10px;}
    th, td { border:1px solid #ccc; padding:8px; text-align:left;}
    th { background:#007bff; color:white;}
    .hidden { display:none;}
</style>
</head>
<body>

<div class="box">
    <h2>Historial de Solicitudes</h2>

    <div class="filtro">
        <input type="date" id="fechaInicio">
        <input type="date" id="fechaFin">
        <button onclick="cargarHistorial()">Filtrar</button>
    </div>

    <div id="historialContenedor">Cargando historial...</div>
    <button onclick="location.href='menu.html'" style="margin-top:15px;">Volver al Menú</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxKBcwZNWU2HpqhO40VxW1r3BQtdv9i3vF4sDQT4Luh1RINjCysBv4i0v6crhMSIJsc/exec"; // Reemplaza con tu URL de Apps Script

function crearSolicitudHTML(solicitud) {
    let html = `<div class="solicitud">
        <h3 onclick="toggleDetalles('${solicitud.id}')">Solicitud #${solicitud.id} - ${solicitud.fecha} - ${solicitud.asignatura} (${solicitud.docente})</h3>
        <div id="detalles-${solicitud.id}" class="hidden">
            <table>
                <thead><tr><th>Material</th><th>Cantidad</th></tr></thead><tbody>`;
    solicitud.materiales.forEach(m => {
        html += `<tr><td>${m.nombre}</td><td>${m.cantidad}</td></tr>`;
    });
    html += `</tbody></table></div></div>`;
    return html;
}

function toggleDetalles(id) {
    const elem = document.getElementById(`detalles-${id}`);
    elem.classList.toggle("hidden");
}

async function cargarHistorial() {
    const contenedor = document.getElementById("historialContenedor");
    contenedor.innerHTML = "Cargando historial...";

    const user = JSON.parse(localStorage.getItem("currentUser"));
    if (!user) { contenedor.innerHTML = "Usuario no identificado."; return; }

    const fechaInicio = document.getElementById("fechaInicio").value;
    const fechaFin = document.getElementById("fechaFin").value;

    const params = new URLSearchParams({ 
        action: "getHistorial", 
        email: user.email,
        fechaInicio: fechaInicio,
        fechaFin: fechaFin
    });

    try {
        const res = await fetch(API_URL + "?" + params.toString());
        const json = await res.json();
        if (!json.ok) { contenedor.innerHTML = "Error al cargar historial."; return; }

        if (json.data.length === 0) { contenedor.innerHTML = "No hay solicitudes entregadas."; return; }

        contenedor.innerHTML = "";
        json.data.forEach(s => {
            contenedor.innerHTML += crearSolicitudHTML(s);
        });

    } catch(err) {
        contenedor.innerHTML = "Error de conexión con el servidor.";
    }
}

// Cargar historial al iniciar
cargarHistorial();
</script>

</body>
</html>



