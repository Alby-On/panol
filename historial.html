<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Historial de Solicitudes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body { font-family: Arial; background: #f0f2f5; padding: 20px; margin:0; }
    .box {
        background: white; padding: 20px; max-width: 700px; margin:auto; border-radius: 12px;
        box-shadow: 0 0 10px rgba(0,0,0,0.15);
    }
    h2 { text-align:center; margin-bottom: 20px; }
    .filters { margin-bottom: 15px; }
    .filters input { width: 48%; padding: 10px; margin-right: 4%; border-radius: 6px; border:1px solid #aaa; }
    .filters input:last-child { margin-right: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #ccc; padding:10px; text-align:left; }
    th { background:#007bff; color:white; }
    button { background:#6c757d; color:white; padding:10px; border:none; border-radius:6px; cursor:pointer; width:100%; margin-top:15px; }
    button:hover { background:#565e64; }
</style>
</head>
<body>

<div class="box">
    <h2>Historial de Solicitudes</h2>

    <div class="filters">
        <input type="date" id="fechaDesde" placeholder="Desde">
        <input type="date" id="fechaHasta" placeholder="Hasta">
    </div>

    <table id="historialTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Docente</th>
                <th>Asignatura</th>
                <th>Fecha</th>
                <th>Materiales</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <button onclick="location.href='menu.html'">Volver</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxKBcwZNWU2HpqhO40VxW1r3BQtdv9i3vF4sDQT4Luh1RINjCysBv4i0v6crhMSIJsc/exec";

async function cargarHistorial() {
    const user = JSON.parse(localStorage.getItem("currentUser"));
    if(!user) { alert("Debe iniciar sesiÃ³n"); window.location.href="index.html"; return; }

    const res = await fetch(API_URL + "?action=getHistorial&email=" + encodeURIComponent(user.email));
    const json = await res.json();

    if(!json.ok) { alert("Error al cargar historial"); return; }

    const tbody = document.querySelector("#historialTable tbody");
    tbody.innerHTML = "";

    json.data.forEach(solicitud => {
        const fecha = new Date(solicitud.fecha).toLocaleDateString();
        const materiales = solicitud.materiales.map(m => `${m.nombre} (${m.cantidad})`).join(", ");
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${solicitud.id}</td>
            <td>${solicitud.docente}</td>
            <td>${solicitud.asignatura}</td>
            <td>${fecha}</td>
            <td>${materiales}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Filtrado por fecha
function filtrarPorFecha() {
    const desde = document.getElementById("fechaDesde").value;
    const hasta = document.getElementById("fechaHasta").value;

    const filas = document.querySelectorAll("#historialTable tbody tr");
    filas.forEach(fila => {
        const fecha = new Date(fila.cells[3].textContent.split("/").reverse().join("-")); // dd/mm/yyyy
        let mostrar = true;
        if(desde) mostrar &= fecha >= new Date(desde);
        if(hasta) mostrar &= fecha <= new Date(hasta);
        fila.style.display = mostrar ? "" : "none";
    });
}

document.getElementById("fechaDesde").addEventListener("change", filtrarPorFecha);
document.getElementById("fechaHasta").addEventListener("change", filtrarPorFecha);

cargarHistorial();
</script>

</body>
</html>


